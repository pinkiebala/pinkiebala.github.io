<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 2.24.91"/><title data-react-helmet="true"></title><link rel="icon" href="/favicon-32x32.png?v=4a9773549091c227cd2eb82ccd9c5e3a" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link as="script" rel="preload" href="/webpack-runtime-62b33b9d9b306650c6cd.js"/><link as="script" rel="preload" href="/framework-cc03bb45506d81428ff3.js"/><link as="script" rel="preload" href="/app-b07e8a927c1699312da5.js"/><link as="script" rel="preload" href="/component---src-templates-blog-tsx-97d2206dcfc647912165.js"/><link as="fetch" rel="preload" href="/page-data/posts/CLS/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="blog-post-container"><div class="blog-post"><h1>CLS 累積版面位移</h1><h2>November 02, 2020</h2><div class="blog-post-content"><h1>Cumulative Layout Shift (CLS)</h1>
<p>不預期的版面位移會讓使用體驗很糟，想像你正在看一段文字，這時網頁突然長出一張大圖或是廣告，害你不知道剛剛的文字跳到哪裡，感覺很糟對吧？</p>
<p>於是版面位移也被加入效能指標之一，可以透過 Lighthouse V6 測量，佔了 5% 的分數。</p>
<p>好在這個指標其實是最容易修的了，5分輕鬆到手。這邊分享一個簡單好用的技巧</p>
<h2>Aspect ratio boxes</h2>
<p>最容易造成 CLS 就是各種媒體，比方說 <code>&#x3C;img></code> 、廣告，或是嵌入 widget，像圖片如果不知道他的尺寸的話，瀏覽器就得載完圖片才會知道他長寬多少，然後就會把文字擠開，所以如果知道圖片尺寸的話，最好是寫死他的 <code>width</code> ,<code>height</code> 避免版面位移。</p>
<p>那如果今天想要圖片的寬度是 100%，高度可以維持比例呢？有個 CSS 技巧叫做 <a href="https://css-tricks.com/aspect-ratio-boxes/">aspect-ratio-boxes</a> 可以讓圖片的框維持固定的比例。</p>
<p>直接上 code</p>
<pre><code class="language-HTML">&#x3C;div class="aspect-ratio-box">
  &#x3C;div class="aspect-ratio-box-holder">&#x3C;/div>
  &#x3C;img class="aspect-ratio-box-media"  src="...">
&#x3C;/div>
</code></pre>
<pre><code class="language-CSS">.aspect-ratio-box {
  background: lightgray; // Placeholder color;
  position: relative;
}

.aspect-ratio-box-holder {
  padding-top: calc(9 / 16 * 100%); // width:height = 16:9
}

.aspect-ratio-box-media {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}
</code></pre>
<p>這段 code 的關鍵就是 <code>padding-top: calc(9 / 16 * 100%);</code>，因為 CSS 有個特性，百分比的 padding，是用 parent 的 width 來算的，如果 <code>aspect-ratio-box</code> 寬 <code>100px</code>，<code>aspect-ratio-box-holder</code> 設定 <code>padding-top: 75%</code> 那就等於 <code>padding-top: 75px</code> 的意思。</p>
<p>利用這個特性就可以做出 responsive 的圖片框，就不會因為圖片載入時造成版面位移了。</p>
<h2>補充雷坑</h2>
<p>另外還有一個細節是 css 的 <code>position</code>、 <code>left</code> 這種的變動，也會被算做 CLS，如果要做動畫之類的話，請用 <code>transform: translate()</code>。</p>
<p>會踩到這個坑是因為用到 <a href="https://github.com/akiran/react-slick">react-slick</a> 這個套件，這是以前搭配 jQuery 使用的 <a href="https://kenwheeler.github.io/slick/">slick</a> 的 React 替代版。</p>
<p>他的 center mode 在 server-side render 的時候，會用 <code>left</code> 搭配每個 slide 的 width 來計算要位移多少，但是在 client-side js 動起來後，會用 <code>transform: translate</code> 來做輪轉動畫。我們首頁最大的 slick 雖然在 client-side js 動起來後，畫面看起來一模一樣，卻有著高達 0.4 的 CLS。</p>
<p>為了修正這個問題，我先用一個 css class 強行 override 他的 <code>left</code> 並用 <code>translate</code> 去實作一樣的初始位移， client-side js didMount 的時候再把他拿掉，才把這個問題解掉。</p></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/posts/CLS";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-01365ee183870cafc13e.js"],"app":["/app-b07e8a927c1699312da5.js"],"component---src-pages-404-js":["/component---src-pages-404-js-9c04155390b493ad90ef.js"],"component---src-pages-index-js":["/component---src-pages-index-js-0e8324ce760316d589ed.js"],"component---src-pages-page-2-js":["/component---src-pages-page-2-js-6f9304e8e0b72f58449a.js"],"component---src-pages-using-typescript-tsx":["/component---src-pages-using-typescript-tsx-d51a13ff025a3ef04cea.js"],"component---src-templates-blog-tsx":["/component---src-templates-blog-tsx-97d2206dcfc647912165.js"]};/*]]>*/</script><script src="/polyfill-01365ee183870cafc13e.js" nomodule=""></script><script src="/component---src-templates-blog-tsx-97d2206dcfc647912165.js" async=""></script><script src="/app-b07e8a927c1699312da5.js" async=""></script><script src="/framework-cc03bb45506d81428ff3.js" async=""></script><script src="/webpack-runtime-62b33b9d9b306650c6cd.js" async=""></script></body></html>